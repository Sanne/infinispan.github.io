<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="generator" content="Asciidoctor 1.5.4"> <title>Clustering</title> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"> <style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css"> <style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style> </head> <body class="book"> <div id="header"> </div> <div id="content"> <div class="sect1"> <h2 id="_clustering"><a class="anchor" href="#_clustering"></a>1. Clustering</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan can be configured to be either local (standalone) or clustered. If in a cluster, the cache can be configured to replicate changes to all nodes, to invalidate changes across nodes and finally to be used in distributed mode - state changes are replicated to a small subset of nodes enough to be fault tolerant but not too many nodes to prevent scalability.</p> </div> <div class="sect2"> <h3 id="_local_mode"><a class="anchor" href="#_local_mode"></a>1.1. Local Mode</h3> <div class="paragraph"> <p>While Infinispan is particularly interesting in clustered mode, it also offers a very capable local mode. In this mode, it acts as a simple, in-memory data cache similar to JBoss Cache and EHCache.</p> </div> <div class="paragraph"> <p>But why would one use a local cache rather than a map? Caches offer a lot of features over and above a simple map, including write-through and write-behind caching to persist data, eviction of entries to prevent running out of memory, and support for expirable entries. Infinispan, specifically, is built around a high-performance, read-biased data container which uses modern techniques similar to <a href="http://en.wikipedia.org/wiki/Read-copy-update">read-copy-update</a>&#8201;&#8212;&#8201;which buys you non-blocking, thread-safe reads even when concurrent writes are taking place. Infinispan also makes heavy use of compare-and-swap and other lock-free algorithms, making it ideal for high-throughput, multi-CPU/multi-core environments. Further, Infinispan&#8217;s Cache API extends the JDK&#8217;s ConcurrentMap - making migration from a map to Infinispan trivial.</p> </div> </div> <div class="sect2"> <h3 id="_replicated_mode"><a class="anchor" href="#_replicated_mode"></a>1.2. Replicated Mode</h3> <div class="paragraph"> <p>Replication is a simple clustered mode where cache instances automatically discover neighboring instances on other JVMs on the same local network, and form a cluster. Entries added to any of these cache instances will be replicated to all other cache instances in the cluster, and can be retrieved locally from any instance. This clustered mode provides a quick and easy way to share state across a cluster, however replication practically only performs well in small clusters (under 10 nodes), due to the number of replication messages that need to happen - as the cluster size increases. Infinispan can be configured to use UDP multicast which mitigates this problem to some degree.</p> </div> <div class="imageblock"> <div class="content"> <img src="images/Figure1_6.png" alt="Figure1 6"> </div> <div class="title">Figure 1. Replication mode</div> </div> <div class="paragraph"> <p>Replication can be synchronous or asynchronous. Use of either one of the options is application dependent. Synchronous replication blocks the caller (e.g. on a put() ) until the modifications have been replicated successfully to all nodes in a cluster. Asynchronous replication performs replication in the background (the put() returns immediately). Infinispan offers a replication queue, where modifications are replicated periodically (i.e. interval-based), or when the queue size exceeds a number of elements, or a combination thereof. A replication queue can therefore offer much higher performance as the actual replication is performed by a background thread.</p> </div> <div class="paragraph"> <p>Asynchronous replication is faster (no caller blocking), because synchronous replication requires acknowledgments from all nodes in a cluster that they received and applied the modification successfully (round-trip time). However, when a synchronous replication returns successfully, the caller knows for sure that all modifications have been applied to all cache instances, whereas this is not be the case with asynchronous replication. With asynchronous replication, errors are simply written to a log. Even when using transactions, a transaction may succeed but replication may not succeed on all cache instances.</p> </div> </div> <div class="sect2"> <h3 id="_invalidation_mode"><a class="anchor" href="#_invalidation_mode"></a>1.3. Invalidation Mode</h3> <div class="paragraph"> <p>Invalidation is a clustered mode that does not actually share any data at all, but simply aims to remove data that may be stale from remote caches. This cache mode only makes sense if you have another, permanent store for your data such as a database and are only using Infinispan as an optimization in a read-heavy system, to prevent hitting the database every time you need some state. If a cache is configured for invalidation rather than replication, every time data is changed in a cache other caches in the cluster receive a message informing them that their data is now stale and should be evicted from memory.</p> </div> <div class="imageblock"> <div class="content"> <img src="images/Figure2_5.png" alt="Figure2 5"> </div> <div class="title">Figure 2. Invalidation mode</div> </div> <div class="paragraph"> <p>Invalidation, when used with a shared cache loader would cause remote caches to refer to the shared cache loader to retrieve modified data. The benefit of this is twofold: network traffic is minimized as invalidation messages are very small compared to replicating updated data, and also that other caches in the cluster look up modified data in a lazy manner, only when needed.</p> </div> <div class="paragraph"> <p>Invalidation messages are sent after each modification (no transactions or batches), or at the end of a transaction or batch, upon successful commit. This is usually more efficient as invalidation messages can be optimized for the transaction as a whole rather than on a per-modification basis.</p> </div> <div class="paragraph"> <p>Invalidation too can be synchronous or asynchronous, and just as in the case of replication, synchronous invalidation blocks until all caches in the cluster receive invalidation messages and have evicted stale data while asynchronous invalidation works in a 'fire-and-forget' mode, where invalidation messages are broadcast but doesn&#8217;t block and wait for responses.</p> </div> </div> <div class="sect2"> <h3 id="_distribution_mode"><a class="anchor" href="#_distribution_mode"></a>1.4. Distribution Mode</h3> <div class="paragraph"> <p>Distribution is a powerful clustering mode which allows Infinispan to scale linearly as more nodes are added to the cluster. Distribution makes use of a hash algorithm to determine on which node(s) entries should be stored. The number of copies that should be maintained in the cluster for each cache entry is configurable (<strong>numOwners</strong>). The number of copies represents the trade-off between performance and durability of data. The more copies you maintain, the lower performance will be, but also the lower the risk of losing data due to server outages. Regardless of how many copies are maintained, distribution still scales linearly and this is key to Infinispan&#8217;s scalability.</p> </div> <div class="paragraph"> <p>Another feature of the hash algorithm is that it is deterministic in locating entries without resorting to multicast requests or maintaining expensive metadata. Doing a GET anywhere will result in at most <em>numOwners</em> remote calls. The remote GET requests are staggered: we request the value from the primary owner, but if it doesn&#8217;t respond in a reasonable amount of time, we request the value from the backup owners as well. (The {{infinispan.stagger.delay}} system property, in milliseconds, controls the delay between requests.) A GET may also result in 0 remote calls if the key is present in the local cache. Doing a PUT can result in more remote calls, depending on the cache configuration (e.g. whether the cache is transactional).</p> </div> <div class="sect3"> <h4 id="_read_consistency"><a class="anchor" href="#_read_consistency"></a>1.4.1. Read consistency</h4> <div class="paragraph"> <p>Since GETs are sent to all data owners in parallel and the first returning result is used, this can lead to data inconsistency when using an <em>asynchronous</em> transport. If an updating thread modifies the primary data owner, but updates are only sent to backup nodes asynchronously, a concurrent read from the same thread may read a stale value for a short period of time until the asynchronous replication completes.</p> </div> <div class="paragraph"> <p>Note that this is <em>only</em> if the transport is <em>asynchronous</em>. If using a <em>synchronous</em> transport this behavior is not exhibited.</p> </div> <div class="imageblock"> <div class="content"> <img src="images/Figure3_3.png" alt="Figure3 3"> </div> <div class="title">Figure 3. Distribution mode</div> </div> </div> <div class="sect3"> <h4 id="_hashing_algorithms"><a class="anchor" href="#_hashing_algorithms"></a>1.4.2. Hashing Algorithms</h4> <div class="paragraph"> <p>The hashing algorithm in Infinispan is based on <a href="http://en.wikipedia.org/wiki/Consistent_hashing">consistent hashing</a>, and even though our implementation has diverged a bit, we still use the term <strong>consistent hash</strong>.</p> </div> <div class="paragraph"> <p>Unlike in consistent hashing, we split the key space into fixed <strong>segments</strong>. The number of segments is configurable (<strong>numSegments</strong>), and it cannot be changed without restarting the cluster. The mapping of keys to segments is also fixed&#8201;&#8212;&#8201;a key should map to the same segment, regardless of how the topology of the cluster changes.</p> </div> <div class="paragraph"> <p>Each hash segment is mapped to a list of nodes called <strong>owners</strong>. The order matters, because the first owner, also known as the <strong>primary owner</strong>, has a special role in many cache operations (e.g. locking). The other owners are called <strong>backup owners</strong>. There is no hard rule on how the segments are mapped to owners, although the hashing algorithms generally try to balance the number of segments allocated to each node and at the same time minimize the number of segments that have to move after a node joins or leaves the cluster.</p> </div> <div class="paragraph"> <p>The hashing algorithm in Infinispan is customizable, and in fact there are five implementations that ship with Infinispan by default:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">org.infinispan.distribution.ch.DefaultConsistentHashFactory</dt> <dd> <p>The default hashing algorithm. It achieves a pretty even distribution, but it has one disadvantage: the mapping of segments to nodes depends on the order in which caches joined the cluster, so a key&#8217;s owners are not guaranteed to be the same in all the caches running in a cluster.</p> </dd> <dt class="hdlist1">org.infinispan.distribution.ch.TopologyAwareConsistentHashFactory</dt> <dd> <p>Selected automatically when <a href="#ServerHinting">Server Hinting</a> is enabled. Similar to the default algorithm, but also tries to spread each segment&#8217;s copies across as many sites, racks, or machines as possible.</p> </dd> <dt class="hdlist1">org.infinispan.distribution.ch.SyncConsistentHashFactory</dt> <dd> <p>An alternative algorithm, closer to consistent hashing (but still not exactly the same). It addresses the weakness of the default algorithm, and always assigns a key to the same node in every cache as long as the cluster is symmetric. It does have some weaknesses of itself, though: the load distribution is less even, and it also moves more segments than necessary on a join or leave.</p> </dd> <dt class="hdlist1">org.infinispan.distribution.ch.TopologyAwareSyncConsistentHashFactory</dt> <dd> <p>Similar to <em>SyncConsistentHashFactory</em>, but adapted for <a href="#ServerHinting">Server Hinting</a>.</p> </dd> <dt class="hdlist1">org.infinispan.distribution.ch.ReplicatedConsistentHashFactory</dt> <dd> <p>This algorithm is used internally to implement replicated caches. Users should never select this explicitly in a distributed cache.</p> </dd> </dl> </div> <div class="sect4"> <h5 id="_capacity_factors"><a class="anchor" href="#_capacity_factors"></a>Capacity Factors</h5> <div class="paragraph"> <p>The nodes in a cluster are not always identical. It is possible to have "non-standard" nodes that take <em>2x</em> as much load as a regular node, or <em>0.5x</em> as much load as a regular node, using the <strong>capacityFactor</strong> setting. The capacity factor can be any non-negative number, and the hashing algorithm will try to assign to each node a load weighted by its capacity factor (both as a primary owner and as a backup owner).</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Capacity factors support is new in Infinispan 6.0. </td> </tr> </table> </div> <div class="paragraph"> <p>One interesting use case is nodes with a capacity factor of <em>0</em>. This could be useful when some nodes are too short-lived to be useful as data owners, but they can&#8217;t use HotRod (or other remote protocols) because they need transactions. With cross-site replication as well, the "site master" should only deal with forwarding commands between sites and shouldn&#8217;t handle user requests, so it makes sense to configure it with a capacity factor of 0.</p> </div> </div> <div class="sect4"> <h5 id="_hashing_configuration"><a class="anchor" href="#_hashing_configuration"></a>Hashing Configuration</h5> <div class="paragraph"> <p>This is how you configure hashing declaratively, via XML:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">   <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">distributedCache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">segments</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">capacity-factor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>And this is how you can configure it programmatically, in Java:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering()
      .cacheMode(CacheMode.DIST_SYNC)
      .hash()
         .numOwners(<span class="integer">2</span>)
         .numSegments(<span class="integer">100</span>)
         .capacityFactor(<span class="integer">2</span>)
   .build();</code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="_initial_cluster_size"><a class="anchor" href="#_initial_cluster_size"></a>1.4.3. Initial cluster size</h4> <div class="paragraph"> <p>Infinispan&#8217;s very dynamic nature in handling toplogy changes (i.e. nodes being added / removed at runtime) means that, normally, a node doesn&#8217;t wait for the presence of other nodes before starting. While this is very flexible, it might not be suitable for applications which require a specific number of nodes to join the cluster before caches are started. For this reason, you can specify how many nodes should have joined the cluster before proceeding with cache initialization. To do this, use the <em>initialClusterSize</em> and <em>initialClusterTimeout</em> transport properties. The declarative XML configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">   <span class="tag">&lt;transport</span> <span class="attribute-name">initial-cluster-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-cluster-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The programmatic Java configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration global = <span class="keyword">new</span> GlobalConfigurationBuilder()
   .transport()
       .initialClusterSize(<span class="integer">4</span>)
       .initialClusterTimeout(<span class="integer">30000</span>)
   .build();</code></pre> </div> </div> <div class="paragraph"> <p>The above configuration will wait for <em>4</em> nodes to join the cluster before initialization. If the initial nodes do not appear within the specified timeout, the cache manager will fail to start.</p> </div> </div> <div class="sect3"> <h4 id="_l1_caching"><a class="anchor" href="#_l1_caching"></a>1.4.4. L1 Caching</h4> <div class="paragraph"> <p>To prevent repeated remote calls when doing multiple GETs, L1 caching can be enabled. L1 caching places remotely received values in a near cache for a short period of time (configurable) so repeated lookups would not result in remote calls. In the above diagram, if L1 was enabled, a subsequent GET for the same key on Server3 would not result in any remote calls.</p> </div> <div class="imageblock"> <div class="content"> <img src="images/Figure4_4.png" alt="Figure4 4"> </div> <div class="title">Figure 4. L1 caching</div> </div> <div class="paragraph"> <p>L1 caching is not free though. Enabling it comes at a cost, and this cost is that every time a key is updated, an invalidation message needs to be multicast to ensure nodes with the entry in L1 invalidates the entry. L1 caching causes the requesting node to cache the retrieved entry locally and listen for changes to the key on the wire. L1-cached entries are given an internal expiry to control memory usage. Enabling L1 will improve performance for repeated reads of non-local keys, but will increase memory consumption to some degree. It offers a nice tradeoff between the "read-mostly" performance of an invalidated data grid with the scalability of a distributed one. Is L1 caching right for you? The correct approach is to benchmark your application with and without L1 enabled and see what works best for your access pattern.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Looking for Buddy Replication?  Buddy Replication - from JBoss Cache - does not exist in Infinispan.  See this blog article which discusses the reasons why Buddy Replication was not implemented in Infinispan, and how the same effects can be achieved using Infinispan: <a href="http://infinispan.blogspot.com/2009/08/distribution-instead-of-buddy.html" class="bare">http://infinispan.blogspot.com/2009/08/distribution-instead-of-buddy.html</a> </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="ServerHinting"><a class="anchor" href="#ServerHinting"></a>1.4.5. Server Hinting</h4> <div class="paragraph"> <p>The motivations behind this feature is to ensure when using distribution, backups are not picked to reside on the same physical server, rack or data centre. For obvious reasons it doesn&#8217;t work with total replication.</p> </div> <div class="sect4"> <h5 id="_configuration"><a class="anchor" href="#_configuration"></a>Configuration</h5> <div class="paragraph"> <p>The hints are configured at transport level:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;transport</span>
    <span class="attribute-name">cluster</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">MyCluster</span><span class="delimiter">&quot;</span></span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="attribute-name">machine</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">LinuxServer01</span><span class="delimiter">&quot;</span></span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="attribute-name">rack</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">Rack01</span><span class="delimiter">&quot;</span></span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="attribute-name">site</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">US-WestCoast</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The following topology hints can be specified:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">machine</dt> <dd> <p>This is probably the most useful, to disambiguate between multiple JVM instances on the same node, or even multiple virtual hosts on the same physical host.</p> </dd> <dt class="hdlist1">rack</dt> <dd> <p>In larger clusters with nodes occupying more than a single rack, this setting would help prevent backups being stored on the same rack.</p> </dd> <dt class="hdlist1">site</dt> <dd> <p>To differentiate between nodes in different data centres replicating to each other. Note that <a href="#CrossSiteReplication">Cross site replication</a> is another alternative for clusters that need to span two or more data centres.</p> </dd> </dl> </div> <div class="paragraph"> <p>All of the above are optional, and if not provided, the distribution algorithms provide no guarantees that backups will not be stored in instances on the same machine/rack/site.</p> </div> </div> </div> <div class="sect3"> <h4 id="KeyAffinityService"><a class="anchor" href="#KeyAffinityService"></a>1.4.6. Key affinity service</h4> <div class="paragraph"> <p>The key affinity service solves the following problem: for a distributed Infinispan cluster one wants to make sure that a value is placed in a certain node. Based on a supplied cluster <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/remoting/transport/Address.html">address</a> identifying the node, the service returns a key that will be hashed to that particular node.</p> </div> <div class="sect4"> <h5 id="_api"><a class="anchor" href="#_api"></a>API</h5> <div class="paragraph"> <p>Following code snippet depicts how a reference to this service can be obtained and used.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// 1. Obtain a reference to a cache manager</span>
EmbeddedCacheManager cacheManager = getCacheManager();<span class="comment">//obtain a reference to a cache manager</span>
Cache cache = cacheManager.getCache();
<span class="error"> </span>
<span class="comment">// 2. Create the affinity service</span>
KeyAffinityService keyAffinityService = KeyAffinityServiceFactory.newLocalKeyAffinityService(
      cache,
      <span class="keyword">new</span> RndKeyGenerator(),
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="predefined-type">Executors</span>.newSingleThreadExecutor(),
      <span class="integer">100</span>);
<span class="error"> </span>
<span class="comment">// 3. Obtain a key to be mapped to a certain address</span>
<span class="predefined-type">Object</span> localKey = keyAffinityService.getKeyForAddress(cacheManager.getAddress());
<span class="error"> </span>
<span class="comment">// 4. This put makes sure that the key resigns on the local node (as obtained cacheManager.getAddress())</span>
cache.put(localKey, <span class="string"><span class="delimiter">&quot;</span><span class="content">yourValue</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>The service is started at step 2: after this point it uses the supplied <em>Executor</em> to generate and queue keys. At step 3, we obtain a key for this service, and use it at step 4, with that guarantee that it is distributed on the node identified by <code>cacheManager.getAddress()</code>.</p> </div> </div> <div class="sect4"> <h5 id="_lifecycle"><a class="anchor" href="#_lifecycle"></a>Lifecycle</h5> <div class="paragraph"> <p><em>KeyAffinityService</em> extends <em>Lifecycle</em>, which allows stopping and (re)starting it:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Lifecycle</span> {
<span class="error"> </span><span class="error"> </span> <span class="type">void</span> start();
<span class="error"> </span><span class="error"> </span> <span class="type">void</span> stop();
}</code></pre> </div> </div> <div class="paragraph"> <p>The service is instantiated through <em>KeyAffinityServiceFactory</em>. All the factory methods have an <em>Executor</em> parameter, that is used for asynchronous key generation (so that it won&#8217;t happen in the caller&#8217;s thread). It is the user&#8217;s responsibility to handle the shutdown of this <em>Executor</em>.</p> </div> <div class="paragraph"> <p>The <em>KeyAffinityService</em>, once started, needs to be explicitly stopped. This stops the background key generation and releases other held resources.</p> </div> <div class="paragraph"> <p>The only situation in which <em>KeyAffinityService</em> stops by itself is when the cache manager with which it was registered is shutdown.</p> </div> </div> <div class="sect4"> <h5 id="_topology_changes"><a class="anchor" href="#_topology_changes"></a>Topology changes</h5> <div class="paragraph"> <p>When a topology change takes place the key ownership from the <em>KeyAffinityService</em> might change. The key affinity service keep tracks of these topology changes and updates and doesn&#8217;t return stale keys, i.e. keys that would currently map to a different node than the one specified. However, this does not guarantee that at the time the key is used its node affinity hasn&#8217;t changed, e.g.:</p> </div> <div class="ulist"> <ul> <li> <p>Thread <code>T1</code> reads a key <code>k1</code> that maps to node <code>A</code>.</p> </li> <li> <p>A topology change happens which makes <code>k1</code> map to node <code>B</code>.</p> </li> <li> <p><code>T1</code> uses <code>k1</code> to add something to the cache. At this point <code>k1</code> maps to <code>B</code>, a different node than the one requested at the time of read.</p> </li> </ul> </div> <div class="paragraph"> <p>Whilst this is not ideal, it should be a supported behaviour for the application as all the already in-use keys might be moved over during cluster change. The <em>KeyAffinityService</em> provides an access proximity optimisation for stable clusters which doesn&#8217;t apply during the instability of topology changes.</p> </div> </div> </div> <div class="sect3"> <h4 id="_the_grouping_api"><a class="anchor" href="#_the_grouping_api"></a>1.4.7. The Grouping API</h4> <div class="paragraph"> <p>Complementary to <a href="#KeyAffinityService">Key affinity service</a> and similar to <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/atomic/AtomicMap.html">AtomicMap</a>, the grouping API allows you to co-locate a group of entries on the same nodes, but without being able to select the actual nodes.</p> </div> <div class="sect4"> <h5 id="_how_does_it_work"><a class="anchor" href="#_how_does_it_work"></a>How does it work?</h5> <div class="paragraph"> <p>Normally, when you store an entry, Infinispan will take a hash code of the key, map the hash to a hash segment, and store the entry on the nodes which own that segment. Infinispan always uses an algorithm to locate a key, never allowing the nodes on which the entry is stored to be specified manually. This scheme allows any node to know which nodes owns a key, without having to distribute such ownership information. This reduces the overhead of Infinispan, but more importantly improves redundancy as there is no need to replicate the ownership information in case of node failure.</p> </div> <div class="paragraph"> <p>If you use the grouping API, then Infinispan will ignore the hash of the key when deciding which <em>node</em> to store the entry on, and instead use a hash of the group. Infinispan still uses the hash of the key in its internal data structures, so using the grouping API will not slow things down. When the group API is in use, it is important that every node can still compute, using an algorithm, the owners of every key. For this reason, the group cannot be specified manually. The group can either be intrinsic to the entry (generated by the key class) or extrinsic (generated by an external function).</p> </div> </div> <div class="sect4"> <h5 id="_how_do_i_use_the_grouping_api"><a class="anchor" href="#_how_do_i_use_the_grouping_api"></a>How do I use the grouping API?</h5> <div class="paragraph"> <p>First, you must enable groups. If you are configuring Infinispan programmatically, then call:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering().hash().groups().enabled()
   .build();</code></pre> </div> </div> <div class="paragraph"> <p>Or, if you are using XML:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache&gt;</span>
   <span class="tag">&lt;groups</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>If you have control of the key class (you can alter the class definition, it&#8217;s not part of an unmodifiable library), and the determination of the group is not an orthogonal concern to the key class, then we recommend you use an intrinsic group. The intrinsic group can be specified using the <em>@Group</em> annotation placed on the method. Let&#8217;s take a look at an example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">User</span> {
<span class="error"> </span><span class="error"> </span> ...
<span class="error"> </span><span class="error"> </span> <span class="predefined-type">String</span> office;
<span class="error"> </span><span class="error"> </span> ...

<span class="error"> </span><span class="error"> </span> <span class="directive">public</span> <span class="type">int</span> hashCode() {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="comment">// Defines the hash for the key, normally used to determine location</span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> ...
<span class="error"> </span><span class="error"> </span> }

<span class="error"> </span><span class="error"> </span> <span class="comment">// Override the location by specifying a group, all keys in the same</span>
<span class="error"> </span><span class="error"> </span> <span class="comment">// group end up with the same owner</span>
<span class="error"> </span><span class="error"> </span> <span class="annotation">@Group</span>
<span class="error"> </span><span class="error"> </span> <span class="directive">public</span> <span class="predefined-type">String</span> getOffice() {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="keyword">return</span> office;
<span class="error"> </span><span class="error"> </span> }
<span class="error"> </span><span class="error"> </span> }
}</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The group must be a <code>String</code> </td> </tr> </table> </div> <div class="paragraph"> <p>If you don&#8217;t have control over the key class, or the determination of the group is an orthogonal concern to the key class, we recommend you use an extrinsic group. An extrinsic group is specified by implementing the <em>Grouper</em> interface, which has a single method computeGroup, which should return the group. <em>Grouper</em> acts as an interceptor, passing the previously computed value in. The group passed to the first <em>Grouper</em> will be that determined by <em>@Group</em> (if <em>@Group</em> is defined). This allows you even greater control over the group when using an intrinsic group. For a grouper to be used when determining the group for a key, its <em>keyType</em> must be assignable from the key being grouped.</p> </div> <div class="paragraph"> <p>Let&#8217;s take a look at an example of a <em>Grouper</em>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">KXGrouper</span> <span class="directive">implements</span> Grouper&lt;<span class="predefined-type">String</span>&gt; {

<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="comment">// A pattern that can extract from a &quot;kX&quot; (e.g. k1, k2) style key</span>
   <span class="comment">// The pattern requires a String key, of length 2, where the first character is</span>
   <span class="comment">// &quot;k&quot; and the second character is a digit. We take that digit, and perform</span>
   <span class="comment">// modular arithmetic on it to assign it to group &quot;1&quot; or group &quot;2&quot;.</span>
<span class="error"> </span><span class="error"> </span> <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">Pattern</span> kPattern = <span class="predefined-type">Pattern</span>.compile(<span class="string"><span class="delimiter">&quot;</span><span class="content">(^k)(&lt;a&gt;</span><span class="char">\\</span><span class="content">d&lt;/a&gt;)$</span><span class="delimiter">&quot;</span></span>);

<span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="directive">public</span> <span class="predefined-type">String</span> computeGroup(<span class="predefined-type">String</span> key, <span class="predefined-type">String</span> group) {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="predefined-type">Matcher</span> matcher = kPattern.matcher(key);
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="keyword">if</span> (matcher.matches()) {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="predefined-type">String</span> g = <span class="predefined-type">Integer</span>.parseInt(matcher.group(<span class="integer">2</span>)) % <span class="integer">2</span> + <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="keyword">return</span> g;
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> } <span class="keyword">else</span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="keyword">return</span> <span class="predefined-constant">null</span>;
<span class="error"> </span><span class="error"> </span><span class="error"> </span> }

<span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="directive">public</span> <span class="predefined-type">Class</span>&lt;<span class="predefined-type">String</span>&gt; getKeyType() {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="keyword">return</span> <span class="predefined-type">String</span>.class;
<span class="error"> </span><span class="error"> </span><span class="error"> </span> }
}</code></pre> </div> </div> <div class="paragraph"> <p>Here we determine a simple grouper that can take the key class and extract from the group from the key using a pattern. We ignore any group information specified on the key class.</p> </div> <div class="paragraph"> <p>You must register every grouper you wish to have used. If you are configuring Infinispan programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering().hash().groups().enabled().addGrouper(<span class="keyword">new</span> KXGrouper())
   .build();</code></pre> </div> </div> <div class="paragraph"> <p>Or, if you are using XML:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache&gt;</span>
   <span class="tag">&lt;groups</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;grouper</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.KXGrouper</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/groups&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> </div> <div class="sect4"> <h5 id="_advanced_interface"><a class="anchor" href="#_advanced_interface"></a>Advanced Interface</h5> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This interface is available since Infinispan 7.0.0. </td> </tr> </table> </div> <div class="paragraph"> <p>AdvancedCache allows to interact with the keys belonging to a group. It is possible to return the Set of keys belonging to a group and remove all the keys of the group. Below is the interface available:</p> </div> <div class="listingblock"> <div class="title">AdvancedCache.java</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * It fetches all the keys which belong to the group.
 * &lt;p/&gt;
 * Semantically, it iterates over all the keys in memory and persistence, and performs a read operation in the keys
 * found. Multiple invocations inside a transaction ensures that all the keys previous read are returned and it may
 * return newly added keys to the group from other committed transactions (also known as phantom reads).
 * &lt;p/&gt;
 * The {@code map} returned is immutable and represents the group at the time of the invocation. If you want to add
 * or remove keys from a group use {@link #put(Object, Object)} and {@link #remove(Object)}. To remove all the keys
 * in the group use {@link #removeGroup(String)}.
 * &lt;p/&gt;
 * To improve performance you may use the {@code flag} {@link org.infinispan.context.Flag#SKIP_CACHE_LOAD} to avoid
 * fetching the key/value from persistence. However, you will get an inconsistent snapshot of the group.
 *
 * @param groupName the group name.
 * @return an immutable {@link java.util.Map} with the key/value pairs.
 */</span>
<span class="predefined-type">Map</span>&lt;K, V&gt; getGroup(<span class="predefined-type">String</span> groupName);

<span class="comment">/**
 * It removes all the key which belongs to a group.
 * &lt;p/&gt;
 * Semantically, it fetches the most recent group keys/values and removes them.
 * &lt;p/&gt;
 * Note that, concurrent addition perform by other transactions/threads to the group may not be removed.
 *
 * @param groupName the group name.
 */</span>
<span class="type">void</span> removeGroup(<span class="predefined-type">String</span> groupName);</code></pre> </div> </div> </div> </div> </div> <div class="sect2"> <h3 id="_asynchronous_options"><a class="anchor" href="#_asynchronous_options"></a>1.5. Asynchronous Options</h3> <div class="paragraph"> <p>When Infinispan instances are clustered, regardless of the cluster mode, data can be propagated to other nodes in a synchronous or asynchronous way. When synchronous, the sender waits for replies from the receivers and when asynchronous, the sender sends the data and does not wait for replies from other nodes in the cluster.</p> </div> <div class="paragraph"> <p>With asynchronous modes, speed is more important than consistency and this is particularly advantageous in use cases such as HTTP session replication with sticky sessions enabled. In these scenarios, data, or in this case a particular session, is always accessed on the same cluster node and only in case of failure is data accessed in a different node. This type of architectures allow consistency to be relaxed in favour of increased performance.</p> </div> <div class="paragraph"> <p>In order to choose the asynchronous configuration that best suits your application, it&#8217;s important to understand the following configuration settings:</p> </div> <div class="sect3"> <h4 id="_asynchronous_communications"><a class="anchor" href="#_asynchronous_communications"></a>1.5.1. Asynchronous Communications</h4> <div class="paragraph"> <p>Whenever you add <a href="http://docs.jboss.org/infinispan/8.2/configdocs/infinispan-config-8.2.html"><code>&lt;replicated-cache mode="ASYNC"&gt; or &lt;distributed-cache mode="ASYNC"&gt; or &lt;invalidation-cache mode="ASYNC"&gt;</code></a> element, you&#8217;re telling the underlying JGroups layer in Infinispan to use asynchronous communication. What this means is that JGroups will send any replication/distribution/invalidation request to the wire but will not wait for a reply from the receiver.</p> </div> </div> <div class="sect3"> <h4 id="_replication_queue"><a class="anchor" href="#_replication_queue"></a>1.5.2. Replication Queue</h4> <div class="paragraph"> <p>The aim of the replication queue is to batch the individual cache operations and send them as one, as opposed to sending each cache operation individually. As a result, replication queue enabled configurations perform generally better compared to those that have it switched off because less RPC messages are sent, fewer envelopes are used&#8230;&#8203;etc. The only real trade off to the replication queue is that the queue is flushed periodically (based on time or queue size) and hence it might take longer for the replication/distribution/invalidation to be realised across the cluster. When replication queue is turned off, data is placed directly on the wire and hence it takes less for data to arrive to other nodes.</p> </div> </div> <div class="sect3"> <h4 id="_asynchronous_api"><a class="anchor" href="#_asynchronous_api"></a>1.5.3. Asynchronous API</h4> <div class="paragraph"> <p>Finally, the <a href="#_asynchronous_api">Asynchronous API</a> can be used to emulate non-blocking APIs, whereby calls are handed over to a different thread and asynchronous API calls return to the client immediately. Using this API can lead to reordering, so you should avoid calling modifying asynchronous methods on the same keys.</p> </div> </div> <div class="sect3"> <h4 id="_return_values"><a class="anchor" href="#_return_values"></a>1.5.4. Return Values</h4> <div class="paragraph"> <p>Regardless of the asynchronous option used, the return values of cache operations are reliable. If talking about return values of cache operations that return previous value, the correctness of these returns are guaranteed as well regardless of the clustering mode. With replication, the previous value is already available locally, and with distribution, regardless of whether it&#8217;s asynchronous or synchronous, Infinispan sends a synchronous request to get the previous value if not present locally. If on the other hand the asynchronous API is used, client code needs to get hold of the <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/commons/util/concurrent/NotifyingFuture.html">NotifiyngFuture</a> returned by the async operation in order to be able to query the previous value.</p> </div> </div> </div> <div class="sect2"> <h3 id="_partition_handling"><a class="anchor" href="#_partition_handling"></a>1.6. Partition handling</h3> <div class="paragraph"> <p>An Infinispan cluster is built out of a number of nodes where data is stored. In order not to lose data in the presence of node failures, Infinispan copies the same data - cache entry in Infinispan parlance - over multiple nodes. This level of data redundancy is configured through the <strong>numOwners</strong> configuration attribute and ensures that as long as fewer than <strong>numOwners</strong> nodes crash simultaneously, Infinispan has a copy of the data available.</p> </div> <div class="paragraph"> <p>However there might be catastrophic situations in which more than <strong>numOwners</strong> nodes disappear from the cluster:</p> </div> <div class="ulist"> <ul> <li> <p>split brain. Caused e.g. by a router crash, this splits the cluster in two or more partitions, or sub-clusters that operate independently. In these circumstances, multiple clients reading/writing from different partitions see different versions of the same cache entry, which for many application is problematic. Note there are ways to alleviate the possibility for the split brain to happen, such as redundant networks or <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/s2-networkscripts-interfaces-chan.html">IP bonding</a>. These only reduce the window of time for the problem to occur, though.</p> </li> <li> <p><strong>numOwners</strong> nodes crash in sequence. When at least <strong>numOwners</strong> nodes crash in rapid sequence and Infinispan does not have the time to properly rebalance its state between crashes, the result is partial data lost.</p> </li> </ul> </div> <div class="paragraph"> <p>The partition handling functionality discussed in this section allows the user to be informed when data has been lost, temporarily or permanently, and wait for the cluster to heal. The goal is to avoid situations in which wrong data is returned to the user as a result of either split brain or multiple nodes crashing in rapid sequence. In terms of Brewer&#8217;s <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a> , enabling partition handling in Infinispan preserves data consistency but sacrifices availability in the presence of partitions.</p> </div> <div class="paragraph"> <p>Enabling partition handling is critical for applications that have high consistency requirements: when the data read from the system must be accurate. On the other hand, if Infinispan is used as a best-effort cache, partitions are perfectly tolerable.</p> </div> <div class="paragraph"> <p>The following sections describe the way Infinispan handles <a href="#split-brain">split brain</a> and <a href="#successive-node-failures">successive failures</a> when partition handling is enabled, followed by a section on <a href="#partition-handling-configuration">configuring the partition handling functionality</a>.</p> </div> <div class="sect3"> <h4 id="split-brain"><a class="anchor" href="#split-brain"></a>1.6.1. Split brain</h4> <div class="paragraph"> <p>In a split brain situation, each network partition will install its own JGroups view, removing the nodes from the other partition(s). We don&#8217;t have a direct way of determining whether the has been split into two or more partitions, since the partitions are unaware of each other. Instead, we assume the cluster has split when one or more nodes disappear from the JGroups cluster without sending an explicit leave message.</p> </div> <div class="paragraph"> <p>With partition handling disabled, each such partition would continue to function as an independent cluster. Each partition may only see a part of the data, and each partition could write conflicting updates in the cache.</p> </div> <div class="paragraph"> <p>With partition handling enabled, if we detect a split, each partition does not start a rebalance immediately, but first it checks whether it should enter degraded mode instead:</p> </div> <div class="ulist"> <ul> <li> <p>If at least one segment has lost all its owners (meaning at least <em>numOwners</em> nodes left since the last rebalance ended), the partition enters degraded mode.</p> </li> <li> <p>If the partition does not contain a simple majority of the nodes (floor(numNodes/2) + 1) in the <em>latest stable topology</em>, the partition also enters degraded mode.</p> </li> <li> <p>Otherwise the partition keeps functioning normally, and it starts a rebalance.</p> </li> </ul> </div> <div class="paragraph"> <p>The <em>stable topology</em> is updated every time a rebalance operation ends and the coordinator determines that another rebalance is not necessary.</p> </div> <div class="paragraph"> <p>These rules ensures that at most one partition stays in available mode, and the other partitions enter degraded mode.</p> </div> <div class="paragraph"> <p>When a partition is in degraded mode, it only allows access to the keys that are wholly owned:</p> </div> <div class="ulist"> <ul> <li> <p>Requests (reads and writes) for entries that have all the copies on nodes within this partition are honoured.</p> </li> <li> <p>Requests for entries that are partially or totally owned by nodes that disappeared are rejected with an <code>AvailabilityException</code>.</p> </li> </ul> </div> <div class="paragraph"> <p>This guarantees that partitions cannot write different values for the same key (cache is consistent), and also that one partition can not read keys that have been updated in the other partitions (no stale data).</p> </div> <div class="paragraph"> <p>To exemplify, consider the initial cluster <code>M = {A, B, C, D}</code>, configured in distributed mode with <code>numOwners = 2</code>. Further on, consider three keys <code>k1</code>, <code>k2</code> and <code>k3</code> (that might exist in the cache or not) such that <code>owners(k1) = {A,B}</code>, <code>owners(k2) = {B,C}</code> and <code>owners(k3) = {C,D}</code>. Then the network splits in two partitions, <code>N1 = {A, B}</code> and <code>N2 = {C, D}</code>, they enter degraded mode and behave like this:</p> </div> <div class="ulist"> <ul> <li> <p>on <code>N1</code>, <code>k1</code> is available for read/write, <code>k2</code> (partially owned) and <code>k3</code> (not owned) are not available and accessing them results in an <code>AvailabilityException</code></p> </li> <li> <p>on <code>N2</code>, <code>k1</code> and <code>k2</code> are not available for read/write, <code>k3</code> is available</p> </li> </ul> </div> <div class="paragraph"> <p>A relevant aspect of the partition handling process is the fact that when a split brain happens, the resulting partitions rely on the original consistent hash function (the one that existed before the split brain) in order to calculate key ownership. So it doesn&#8217;t matter if <code>k1</code>, <code>k2</code>, or <code>k3</code> already existed cache or not, their availability is the same.</p> </div> <div class="paragraph"> <p>If at a further point in time the network heals and <code>N1</code> and <code>N2</code> partitions merge back together into the initial cluster <code>M</code>, then <code>M</code> exits the degraded mode and becomes fully available again.</p> </div> <div class="paragraph"> <p>As another example, the cluster could split in two partitions <code>O1 = {A, B, C}</code> and <code>O2 = {D}</code>, partition <code>O1</code> will stay fully available (rebalancing cache entries on the remaining members). Partition <code>O2</code>, however, will detect a split and enter the degraded mode. Since it doesn&#8217;t have any fully owned keys, it will reject any read or write operation with an <code>AvailabilityException</code>.</p> </div> <div class="paragraph"> <p>If afterwards partitions <code>O1</code> and <code>O2</code> merge back into <code>M</code>, then the cache entries on <code>D</code> will be wiped (since they could be stale). <code>D</code> will be fully available, but it will not hold any data until the cache is rebalanced.</p> </div> <div class="sect4"> <h5 id="_current_limitations"><a class="anchor" href="#_current_limitations"></a>Current limitations</h5> <div class="paragraph"> <p>Two partitions could start up isolated, and as long as they don&#8217;t merge they can read and write inconsistent data. In the future, we will allow custom availability strategies (e.g. check that a certain node is part of the cluster, or check that an external machine is accessible) that could handle that situation as well.</p> </div> </div> </div> <div class="sect3"> <h4 id="successive-node-failures"><a class="anchor" href="#successive-node-failures"></a>1.6.2. Successive nodes stopped</h4> <div class="paragraph"> <p>As mentioned in the previous section, Infinispan can&#8217;t detect whether a node left the JGroups view because of a process/machine crash, or because of a network failure: whenever a node leaves the JGroups cluster abruptly, it is assumed to be because of a network problem.</p> </div> <div class="paragraph"> <p>If the configured number of copies (<em>numOwners</em>) is greater than 1, the cluster can remain available and will try to make new replicas of the data on the crashed node. However, other nodes might crash during the rebalance process. If more than <em>numOwners</em> nodes crash in a short interval of time, there is a chance that some cache entries have disappeared from the cluster altogether. In this case, with partition handling functionality enabled, Infinispan assumes (incorrectly) that there is a split brain and enters degraded mode as described in the split-brain section.</p> </div> <div class="paragraph"> <p>The administrator can also shut down more than <strong>numOwners</strong> nodes in rapid succession, causing the loss of the data stored only on those nodes. When the administrator shuts down a node gracefully, Infinispan knows that the node can&#8217;t come back. However, the cluster doesn&#8217;t keep track of how each node left, and the cache still enters <em>degraded</em> mode as if those nodes had crashed.</p> </div> <div class="paragraph"> <p>At this stage there is no way for the cluster to recover its state, except stopping it and repopulating it on restart with the data from an external source. Clusters are expected to be configured with an appropriate <strong>numOwners</strong> in order to avoid <strong>numOwners</strong> successive node failures, so this situation should be pretty rare. If the application can handle losing some of the data in the cache, the administrator can force the availability mode back to AVAILABLE <a href="#partition-handling-monitoring">via JMX</a>.</p> </div> </div> <div class="sect3"> <h4 id="partition-handling-configuration"><a class="anchor" href="#partition-handling-configuration"></a>1.6.3. Configuration for partition handling functionality</h4> <div class="paragraph"> <p>At this stage the partition handling is disabled by default. We will revisit this decision in the future, based on user feedback. In order to enable partition handling within the XML configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">the-default-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;partition-handling</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Unless the cache is distributed or replicated, the configuration is ignored.</p> </div> <div class="paragraph"> <p>The same can be achieved programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder dcc = <span class="keyword">new</span> ConfigurationBuilder();
dcc.clustering().partitionHandling().enabled(<span class="predefined-constant">true</span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="partition-handling-monitoring"><a class="anchor" href="#partition-handling-monitoring"></a>1.6.4. Monitoring and administration</h4> <div class="paragraph"> <p>The availability mode of a cache is exposed in JMX as an attribute in the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/jmxComponents.html#Cache">Cache MBean</a>. The attribute is writable, allowing an administrator to forcefully migrate a cache from degraded state back to available (at the cost of consistency).</p> </div> <div class="paragraph"> <p>The availability mode is also accessible via the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> interface:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">AdvancedCache ac = cache.getAdvancedCache();

<span class="comment">// Read the availability</span>
<span class="type">boolean</span> available = ac.getAvailability() == AvailabilityMode.AVAILABLE;

<span class="comment">// Change the availability</span>
<span class="keyword">if</span> (!available) {
   ac.setAvailability(AvailabilityMode.AVAILABLE);
}</code></pre> </div> </div> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2016-04-30 07:37:32 CEST </div> </div> </body> </html>